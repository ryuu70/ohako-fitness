# 管理者認証セキュリティ設定

このドキュメントでは、管理者認証システムのセキュリティ設定とセットアップ手順について説明します。

## セキュリティ機能

### 1. パスワードハッシュ化
- **PBKDF2-SHA512**を使用したパスワードハッシュ化
- **10000回の反復**でブルートフォース攻撃を防止
- **32バイトのランダムソルト**でレインボーテーブル攻撃を防止

### 2. レート制限
- **15分間に最大5回**の認証試行を制限
- **IPアドレスベース**の制限
- 制限超過時は**15分間のブロック**

### 3. タイミング攻撃対策
- `crypto.timingSafeEqual`を使用した安全な比較
- パスワードの長さや内容による処理時間の違いを隠蔽

### 4. セッション管理
- 認証成功時はレート制限レコードをリセット
- 古いレート制限レコードの自動クリーンアップ

## セットアップ手順

### 1. パスワードハッシュの生成

```bash
# スクリプトを実行してパスワードハッシュを生成
node scripts/generate-password-hash.js <your-secure-password>

# 例
node scripts/generate-password-hash.js MySecurePassword123!
```

### 2. 環境変数の設定

`.env.local`ファイルを作成し、以下の環境変数を設定してください：

```env
# 管理者認証設定
ADMIN_PASSWORD_HASH=<generated-hash>
ADMIN_SALT=<generated-salt>

# 例
ADMIN_PASSWORD_HASH=a1b2c3d4e5f6...
ADMIN_SALT=f1e2d3c4b5a6...
```

### 3. セキュリティチェックリスト

- [ ] 強力なパスワードを使用（8文字以上、大文字・小文字・数字・特殊文字を含む）
- [ ] パスワードハッシュとソルトを環境変数に設定
- [ ] `.env.local`ファイルをGitにコミットしない
- [ ] パスワード生成スクリプトの実行履歴を削除
- [ ] 本番環境ではRedis等の永続化されたレート制限ストレージの使用を検討

## 環境変数の説明

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `ADMIN_PASSWORD_HASH` | ハッシュ化された管理者パスワード | ✅ |
| `ADMIN_SALT` | パスワードハッシュ化に使用するソルト | ✅ |

## セキュリティベストプラクティス

### 1. パスワードポリシー
- 最小8文字以上
- 大文字・小文字・数字・特殊文字を含む
- 辞書に載っている単語を避ける
- 個人情報を含まない

### 2. 環境変数の管理
- 本番環境では環境変数管理サービスを使用
- 開発環境では`.env.local`を使用（Gitにコミットしない）
- 定期的なパスワードローテーション

### 3. 監視とログ
- 認証失敗のログを監視
- レート制限のトリガーを監視
- 異常なアクセスパターンの検出

## トラブルシューティング

### 1. 認証が失敗する場合
- 環境変数が正しく設定されているか確認
- パスワードハッシュとソルトが一致しているか確認
- レート制限に引っかかっていないか確認

### 2. レート制限に引っかかった場合
- 15分間待機
- 正しいパスワードを使用
- 必要に応じて管理者に連絡

### 3. 環境変数エラーが発生する場合
- `.env.local`ファイルが存在するか確認
- 環境変数の値が正しく設定されているか確認
- アプリケーションの再起動

## 本番環境での追加推奨事項

### 1. レート制限ストレージ
```typescript
// Redis等の永続化されたストレージの使用
import Redis from 'ioredis';
const redis = new Redis(process.env.REDIS_URL);
```

### 2. HTTPS強制
```typescript
// 本番環境ではHTTPSを強制
if (process.env.NODE_ENV === 'production') {
  // HTTPSリダイレクト設定
}
```

### 3. セキュリティヘッダー
```typescript
// セキュリティヘッダーの設定
res.setHeader('X-Content-Type-Options', 'nosniff');
res.setHeader('X-Frame-Options', 'DENY');
res.setHeader('X-XSS-Protection', '1; mode=block');
```

## サポート

セキュリティに関する質問や問題が発生した場合は、開発チームに連絡してください。

---

**重要**: このドキュメントに記載されているセキュリティ設定は、システムの安全性を向上させるためのものです。定期的に見直し、最新のセキュリティベストプラクティスに従って更新してください。
